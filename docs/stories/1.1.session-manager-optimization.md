# Story 1.1: Session Manager Completion & Optimization

## Status
Draft

## Story

**As a** system administrator and developer,
**I want** to complete the session manager implementation with proper activity tracking and cleanup mechanisms,
**so that** the system can efficiently manage user sessions, track activity, and maintain optimal performance through automated cleanup of stale sessions.

## Acceptance Criteria

1. **AC1**: The `updateLastActivity()` method is fully implemented and updates the database with actual last activity timestamps
2. **AC2**: The `cleanupOldSessions()` method is implemented and removes sessions older than the configured timeout period
3. **AC3**: Database schema includes `lastActivity` and `isActive` fields in the `conversationSessions` table
4. **AC4**: Connection pooling is optimized for PostgreSQL with proper configuration
5. **AC5**: Session performance monitoring is implemented with metrics collection
6. **AC6**: Session lifecycle tests are created and passing
7. **AC7**: All existing session functionality continues to work without disruption

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Enhancement** (AC: 3)
  - [ ] Add `lastActivity` timestamp field to `conversationSessions` table
  - [ ] Add `isActive` boolean field to `conversationSessions` table
  - [ ] Add `chatId` text field to `conversationSessions` table for WhatsApp integration
  - [ ] Create and run database migration for new fields
  - [ ] Update Drizzle schema definitions in `src/lib/schema.ts`

- [ ] **Task 2: Complete updateLastActivity() Implementation** (AC: 1)
  - [ ] Remove TODO comment and implement actual database update
  - [ ] Update `lastActivity` field with current timestamp
  - [ ] Add proper error handling for database operations
  - [ ] Add logging for activity tracking
  - [ ] Test with multiple concurrent sessions

- [ ] **Task 3: Implement cleanupOldSessions() Method** (AC: 2)
  - [ ] Remove TODO comment and implement actual cleanup logic
  - [ ] Query sessions older than `SESSION_TIMEOUT_MINUTES`
  - [ ] Mark sessions as inactive instead of deleting (soft delete)
  - [ ] Return count of cleaned up sessions
  - [ ] Add proper error handling and logging

- [ ] **Task 4: PostgreSQL Connection Pooling Optimization** (AC: 4)
  - [ ] Review current database connection configuration in `src/lib/db.ts`
  - [ ] Implement connection pooling with appropriate pool size
  - [ ] Add connection health monitoring
  - [ ] Configure connection timeout and retry logic
  - [ ] Test connection stability under load

- [ ] **Task 5: Session Performance Monitoring** (AC: 5)
  - [ ] Add performance metrics collection for session operations
  - [ ] Implement session creation/update/cleanup timing
  - [ ] Add memory usage tracking for session data
  - [ ] Create performance dashboard or logging
  - [ ] Set up alerts for performance degradation

- [ ] **Task 6: Create Session Lifecycle Tests** (AC: 6)
  - [ ] Create unit tests for `updateLastActivity()` method
  - [ ] Create unit tests for `cleanupOldSessions()` method
  - [ ] Create integration tests for session creation and management
  - [ ] Create performance tests for connection pooling
  - [ ] Create end-to-end tests for complete session lifecycle

- [ ] **Task 7: Regression Testing** (AC: 7)
  - [ ] Test existing session creation functionality
  - [ ] Test existing conversation context retrieval
  - [ ] Test existing session timeout behavior
  - [ ] Verify no breaking changes to existing APIs
  - [ ] Test WhatsApp integration compatibility

## Dev Notes

### Previous Story Insights
N/A - This is the first story in the epic.

### Data Models
**Current Schema (conversationSessions table):**
```typescript
export const conversationSessions = pgTable("conversationSessions", {
  id: text("id").primaryKey(),
  userId: text("userId").notNull().references(() => user.id, { onDelete: "cascade" }),
  agent: text("agent").notNull(), // 'financeiro' | 'max' | 'geral'
  title: text("title"),
  createdAt: timestamp("createdAt").notNull().defaultNow(),
  updatedAt: timestamp("updatedAt").notNull().defaultNow(),
});
```

**Required Schema Changes:**
- Add `lastActivity: timestamp("lastActivity").notNull().defaultNow()`
- Add `isActive: boolean("isActive").notNull().default(true)`
- Add `chatId: text("chatId")` (optional for WhatsApp integration)

[Source: docs/brownfield-architecture.md#database-schema]

### API Specifications
**Session Manager Interface:**
```typescript
export interface SessionInfo {
  sessionId: string;
  userId: string;
  chatId?: string;
  agentId?: string;
  isActive: boolean;
  lastActivity: Date;
  messageCount: number;
}
```

**Key Methods to Implement:**
- `updateLastActivity(sessionId: string): Promise<void>`
- `cleanupOldSessions(): Promise<number>`

[Source: src/lib/orchestrator/session-manager.ts]

### Component Specifications
**Session Manager Class:**
- Location: `src/lib/orchestrator/session-manager.ts`
- Current TODOs at lines 124-128 and 210-225
- Uses Drizzle ORM with PostgreSQL
- Singleton pattern with `sessionManager` export

[Source: docs/brownfield-architecture.md#session-management]

### File Locations
**Files to Modify:**
- `src/lib/schema.ts` - Add new database fields
- `src/lib/orchestrator/session-manager.ts` - Complete TODO implementations
- `src/lib/db.ts` - Optimize connection pooling
- `drizzle/` - Add new migration files

**Test Files to Create:**
- `src/lib/orchestrator/__tests__/session-manager.test.ts`
- `src/lib/orchestrator/__tests__/session-lifecycle.test.ts`

[Source: docs/brownfield-architecture.md#project-structure]

### Testing Requirements
**Current Test Infrastructure:**
- No formal test runner configured
- Tests appear to be standalone scripts in root directory
- Primary QA method is manual testing

**Testing Standards for This Story:**
- Create unit tests using Jest or similar framework
- Test file location: `src/lib/orchestrator/__tests__/`
- Test database operations with test database
- Mock external dependencies (OpenAI, Supabase)
- Test error handling and edge cases

[Source: docs/brownfield-architecture.md#testing-reality]

### Technical Constraints
**Database:**
- PostgreSQL via Drizzle ORM
- Supabase as database provider
- Row Level Security (RLS) policies need configuration

**Performance:**
- Session timeout: 30 minutes
- Max messages per session: 50
- Connection pooling required for scalability

**Compatibility:**
- Must maintain backward compatibility with existing session functionality
- WhatsApp integration must continue to work
- No breaking changes to existing APIs

[Source: docs/brownfield-architecture.md#technical-constraints]

### Project Structure Notes
**Directory Structure:**
```
src/lib/orchestrator/
├── session-manager.ts          # Main implementation
├── enhanced-agent-squad.ts     # Agent orchestration
├── multi-layer-classifier.ts   # Classification logic
└── drizzle-storage.ts          # Database abstraction
```

**Database Migrations:**
- Location: `drizzle/` directory
- Use Drizzle Kit for schema management
- Follow existing migration naming pattern

[Source: docs/brownfield-architecture.md#source-tree]

## Testing

### Testing Standards
**Test Framework:** Jest (recommended based on Next.js ecosystem)
**Test Location:** `src/lib/orchestrator/__tests__/`
**Database Testing:** Use test database with proper setup/teardown
**Mocking:** Mock external services (Supabase, OpenAI)

### Specific Testing Requirements
1. **Unit Tests:**
   - Test `updateLastActivity()` with various scenarios
   - Test `cleanupOldSessions()` with different timeout values
   - Test session creation and retrieval
   - Test error handling for database failures

2. **Integration Tests:**
   - Test complete session lifecycle
   - Test concurrent session operations
   - Test database connection pooling
   - Test performance under load

3. **Regression Tests:**
   - Verify existing functionality remains intact
   - Test WhatsApp integration compatibility
   - Test admin panel session management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-29 | 1.0 | Initial story creation from epic requirements | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent during review*

